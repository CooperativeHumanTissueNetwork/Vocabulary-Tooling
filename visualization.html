<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CHTN Vocabulary Hive Plot</title>
    <style>

    .link {
        fill: none;
        stroke-width: 1.5px;
    }

    .axis, .node {
        stroke: #000;
        stroke-width: 1.5px;
    }

    </style>
</head>
<body>
    <p id="info"></p>
    <p id="chart"></p>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="http://d3js.org/d3.hive.v0.min.js"></script>
    <!--script>

        var width = 960,
            height = 850,
            innerRadius = 40,
            outerRadius = 240;

        var angle  = d3.scale.ordinal().domain(d3.range(4)).rangePoints([0, 2 * Math.PI]),
            radius = d3.scale.linear().range([innerRadius, outerRadius]),
            color  = d3.scale.category10().domain(d3.range(20));

        var nodes = [
          {x: 0, y: .1},
          {x: 0, y: .9},
          {x: 1, y: .2},
          {x: 1, y: .3},
          {x: 2, y: .1},
          {x: 2, y: .8}
        ];

        var links = [
          {source: nodes[0], target: nodes[2]},
          {source: nodes[1], target: nodes[3]},
          {source: nodes[2], target: nodes[4]},
          {source: nodes[2], target: nodes[5]},
          {source: nodes[3], target: nodes[5]},
          {source: nodes[4], target: nodes[0]},
          {source: nodes[5], target: nodes[1]}
        ];

        var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height)
          .append("g")
            .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

        svg.selectAll(".axis")
            .data(d3.range(3))
          .enter().append("line")
            .attr("class", "axis")
            .attr("transform", function(d) { return "rotate(" + degrees(angle(d)) + ")"; })
            .attr("x1", radius.range()[0])
            .attr("x2", radius.range()[1]);

        svg.selectAll(".link")
            .data(links)
          .enter().append("path")
            .attr("class", "link")
            .attr("d", d3.hive.link()
                .angle(function(d) { return angle(d.x); })
                .radius(function(d) { return radius(d.y); }))
            .style("stroke", function(d) { return color(d.source.x); });

        svg.selectAll(".node")
            .data(nodes)
          .enter().append("circle")
            .attr("class", "node")
            .attr("transform", function(d) { return "rotate(" + degrees(angle(d.x)) + ")"; })
            .attr("cx", function(d) { return radius(d.y); })
            .attr("r", 5)
            .style("fill", function(d) { return color(d.x); });

        function degrees(radians) {
          return radians / Math.PI * 180 - 90;
        }

    </script-->
    <script>

        function degrees(radians) {
          return radians / Math.PI * 180 - 90;
        }

        d3.json("CHTN Vocab-Disease List.jsonld", function (graph) {
            var width = 960,
                height = 850,
                innerRadius = 40,
                outerRadius = 640,
                majorAngle = 2 * Math.PI / 3,
                minorAngle = 1 * Math.PI / 12;

            var angle = d3.scale.ordinal()
                .domain(["Site", "Diagnosis", "Category"])
                .range([0, majorAngle, 2 * majorAngle]);

            var radius = d3.scale.linear()
                .range([innerRadius, outerRadius]);

            var color = d3.scale.category10();

            var entities = graph["@graph"], entitiesById = {}, links = [], formatNumber = d3.format(",d");

            // Construct an index by Entity Id
            entities.forEach(function (d) {
                d.connectors = [];
                entitiesById[d["@id"]] = d;
            });

            // Convert the compatability relationships into links with sources and targets
            entities.forEach(function (source) {
                var processCompatibility = function (source, target) {
                    if (!source.source) source.connectors.push(source.source = {node: source, degree: 0});
                    if (!target.target) target.connectors.push(target.target = {node: target, degree: 0});
                    links.push({source: source.source, target: target.target});
                }
                if (source.compatible.forEach) {
                    // If there are many compatibility statements, they are in an array.
                    source.compatible.forEach(function (targetObject) {
                        var target = entitiesById[targetObject["@id"]];
                        processCompatibility(source, target);
                    });
                } else {
                    // If there is just one compatibility statement, it's an object
                    var target = entitiesById[source.compatible["@id"]];
                    processCompatibility(source, target);
                }
            });

            // Initialize the info display
            var info = d3.select("#info")
                .text(defaultInfo = "Showing " + formatNumber(links.length) + " dependencies among " + formatNumber(entities.length) + " entities.")

            var svg = d3.select("#chart").append("svg")
                    .attr("width", width)
                    .attr("height", height)
                .append("g")
                    .attr("transform", "translate(" + outerRadius * .20 + "," + outerRadius * .57 + ")");

            // Entities by type
            var entitiesByType = d3.nest()
                .key(function (d) { return d["@type"]; })
                .sortKeys(d3.ascending)
                .entries(entities);
            entitiesByType = entitiesByType.slice(0,3);

            // Compute the rank for each type.
            entitiesByType.forEach(function (type) {
                var count = 0;
                type.values.forEach(function (d,i) {
                    d.index = count++;
                });
            });

            // Set the radius domain.
            radius.domain(d3.extent(entities, function(d) { return d.index; }));

            // Draw the axes.
            svg.selectAll(".axis")
                    .data(entitiesByType)
                .enter().append("line")
                    .attr("class", "axis")
                    .attr("transform", function(d) { return "rotate(" + degrees(angle(d.key)) + ")"; })
                    .attr("x1", radius(-2))
                    .attr("x2", function(d) { return radius(d.values.length + 2); });

            // Draw the links.
            svg.selectAll(".link")

        });
    </script>
</body>
</html>